<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Tester</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        .panel { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); margin-bottom: 20px; }
        h2 { margin-bottom: 15px; color: #333; font-size: 18px; }
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #e0e7ff; color: #667eea; }
        .btn-success { background: #4caf50; color: white; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; }
        .profile-tab { padding: 10px 20px; background: #f8f9ff; border: none; cursor: pointer; font-weight: 600; }
        .profile-tab.active { background: #667eea; color: white; }
        #uploadedImage { max-width: 100%; border-radius: 8px; margin-top: 15px; display: none; }
        #uploadedImage.visible { display: block; }
        .upload-area { border: 2px dashed #667eea; border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; background: #f8f9ff; }
        .result-item { background: #f8f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .image-preview { max-width: 100%; max-height: 300px; border-radius: 6px; margin-top: 10px; }
        .overlay-canvas { position: absolute; top: 0; left: 0; pointer-events: none; display: none; }
        .overlay-canvas.visible { display: block; }
        label { font-weight: 600; display: block; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="panel">
            <h2>Profile Configuration</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="profile-tab active" onclick="switchProfile('Craigslist')">Craigslist</button>
                <button class="profile-tab" onclick="switchProfile('eBay')">eBay</button>
                <button class="profile-tab" onclick="switchProfile('Facebook')">Facebook</button>
            </div>
            
            <textarea id="blacklistKeywords" placeholder="Blacklist keywords" rows="2"></textarea>
            
            <label>Title Strategy:</label>
            <select id="titleStrategy" onchange="toggleTitle()">
                <option value="region">Region-Based</option>
                <option value="first">First Line</option>
            </select>
            <div id="titleRegion">
                <input type="number" id="titleYStart" placeholder="Title Y Start %" value="5" oninput="updateOverlay()">
                <input type="number" id="titleYEnd" placeholder="Title Y End %" value="15" oninput="updateOverlay()">
                <input type="number" id="titleXStart" placeholder="Title X Start %" value="0" oninput="updateOverlay()">
                <input type="number" id="titleXEnd" placeholder="Title X End %" value="100" oninput="updateOverlay()">
            </div>
            
            <label>Description Strategy:</label>
            <select id="descStrategy" onchange="toggleDesc()">
                <option value="region">Region-Based</option>
                <option value="all">All Text</option>
            </select>
            <div id="descRegion">
                <input type="number" id="descYStart" placeholder="Desc Y Start %" value="30" oninput="updateOverlay()">
                <input type="number" id="descYEnd" placeholder="Desc Y End %" value="70" oninput="updateOverlay()">
                <input type="number" id="descXStart" placeholder="Desc X Start %" value="0" oninput="updateOverlay()">
                <input type="number" id="descXEnd" placeholder="Desc X End %" value="100" oninput="updateOverlay()">
            </div>
            
            <label>Image Region:</label>
            <input type="number" id="imageYStart" placeholder="Image Y Start %" value="8" oninput="updateOverlay()">
            <input type="number" id="imageYEnd" placeholder="Image Y End %" value="100" oninput="updateOverlay()">
            <input type="number" id="imageXStart" placeholder="Image X Start %" value="0" oninput="updateOverlay()">
            <input type="number" id="imageXEnd" placeholder="Image X End %" value="100" oninput="updateOverlay()">
            
            <label>Min Title Length:</label>
            <input type="number" id="minTitleLength" placeholder="Min Title Length" value="15">
            
            <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn-secondary" onclick="previewTitle()">üëÅÔ∏è Title</button>
                <button class="btn-secondary" onclick="previewDesc()">üëÅÔ∏è Description</button>
                <button class="btn-secondary" onclick="previewImage()">üëÅÔ∏è Image</button>
            </div>
            
            <button class="btn-success" onclick="saveProfile()" style="margin-top: 10px;">Save Profile</button>
        </div>

        <div class="two-column">
            <div class="panel">
                <h2>Upload & Test</h2>
                <div class="upload-area" id="uploadArea">
                    <p>Drop screenshot here</p>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                </div>
                <div style="position: relative; display: inline-block;">
                    <img id="uploadedImage">
                    <canvas id="overlayCanvas" class="overlay-canvas"></canvas>
                </div>
                <button class="btn-primary" id="extractBtn" disabled onclick="extract()" style="margin-top: 15px;">Extract</button>
            </div>

            <div class="panel">
                <h2>Results</h2>
                <div id="results"></div>
            </div>
        </div>

        <div class="panel">
            <h2>Export</h2>
            <button class="btn-primary" onclick="exportProfiles()">Generate Code</button>
            <pre id="exportCode" style="background: #2d2d2d; color: white; padding: 15px; border-radius: 6px; display: none; margin-top: 10px; overflow-x: auto;"></pre>
        </div>

        <div id="modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000;">
            <div style="background: white; padding: 20px; border-radius: 12px; max-width: 90%; max-height: 90%; overflow: auto;">
                <h3>Preview</h3>
                <img id="previewImg" style="max-width: 100%; margin: 15px 0;">
                <button class="btn-secondary" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        let profiles = {
            'Craigslist': { blacklistKeywords: 'craigslist,posted', titleStrategy: 'region', titleYStart: 5, titleYEnd: 15, titleXStart: 0, titleXEnd: 70, descStrategy: 'region', descYStart: 40, descYEnd: 80, descXStart: 0, descXEnd: 70, imageYStart: 8, imageYEnd: 100, imageXStart: 0, imageXEnd: 100, minTitleLength: 15 },
            'eBay': { blacklistKeywords: 'ebay,cart', titleStrategy: 'region', titleYStart: 10, titleYEnd: 20, titleXStart: 0, titleXEnd: 70, descStrategy: 'region', descYStart: 45, descYEnd: 85, descXStart: 0, descXEnd: 65, imageYStart: 10, imageYEnd: 100, imageXStart: 0, imageXEnd: 70, minTitleLength: 15 },
            'Facebook': { blacklistKeywords: 'facebook,marketplace', titleStrategy: 'region', titleYStart: 3, titleYEnd: 12, titleXStart: 70, titleXEnd: 100, descStrategy: 'region', descYStart: 35, descYEnd: 75, descXStart: 70, descXEnd: 100, imageYStart: 5, imageYEnd: 100, imageXStart: 0, imageXEnd: 70, minTitleLength: 10 }
        };
        let currentProfile = 'Craigslist';
        const img = document.getElementById('uploadedImage');
        const canvas = document.getElementById('overlayCanvas');

        document.getElementById('uploadArea').onclick = () => document.getElementById('fileInput').click();
        document.getElementById('fileInput').onchange = e => {
            if(e.target.files[0]) {
                const r = new FileReader();
                r.onload = ev => {
                    img.src = ev.target.result;
                    img.classList.add('visible');
                    document.getElementById('extractBtn').disabled = false;
                    img.onload = () => { setupCanvas(); updateOverlay(); };
                };
                r.readAsDataURL(e.target.files[0]);
            }
        };

        function setupCanvas() {
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            canvas.style.width = img.clientWidth + 'px';
            canvas.style.height = img.clientHeight + 'px';
        }

        function updateOverlay() {
            if(!img.src) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const tYS = parseInt(document.getElementById('titleYStart').value) || 0;
            const tYE = parseInt(document.getElementById('titleYEnd').value) || 15;
            const tXS = parseInt(document.getElementById('titleXStart').value) || 0;
            const tXE = parseInt(document.getElementById('titleXEnd').value) || 100;
            const dYS = parseInt(document.getElementById('descYStart').value) || 0;
            const dYE = parseInt(document.getElementById('descYEnd').value) || 100;
            const dXS = parseInt(document.getElementById('descXStart').value) || 0;
            const dXE = parseInt(document.getElementById('descXEnd').value) || 100;
            const iYS = parseInt(document.getElementById('imageYStart').value) || 0;
            const iYE = parseInt(document.getElementById('imageYEnd').value) || 100;
            const iXS = parseInt(document.getElementById('imageXStart').value) || 0;
            const iXE = parseInt(document.getElementById('imageXEnd').value) || 100;

            // Title (orange)
            if(document.getElementById('titleStrategy').value === 'region') {
                ctx.strokeStyle = '#ff9800';
                ctx.lineWidth = 3;
                ctx.setLineDash([10, 5]);
                ctx.strokeRect((tXS/100)*canvas.width, (tYS/100)*canvas.height, ((tXE-tXS)/100)*canvas.width, ((tYE-tYS)/100)*canvas.height);
                ctx.setLineDash([]);
            }

            // Image region - show as green box
            ctx.strokeStyle = '#4caf50';
            ctx.lineWidth = 4;
            ctx.strokeRect((iXS/100)*canvas.width, (iYS/100)*canvas.height, ((iXE-iXS)/100)*canvas.width, ((iYE-iYS)/100)*canvas.height);

            // Red overlay for areas outside image region
            ctx.fillStyle = 'rgba(255,0,0,0.3)';
            // Top
            ctx.fillRect(0, 0, canvas.width, (iYS/100)*canvas.height);
            // Bottom
            ctx.fillRect(0, (iYE/100)*canvas.height, canvas.width, canvas.height - (iYE/100)*canvas.height);
            // Left
            ctx.fillRect(0, (iYS/100)*canvas.height, (iXS/100)*canvas.width, ((iYE-iYS)/100)*canvas.height);
            // Right
            ctx.fillRect((iXE/100)*canvas.width, (iYS/100)*canvas.height, canvas.width - (iXE/100)*canvas.width, ((iYE-iYS)/100)*canvas.height);

            // Description (blue)
            if(document.getElementById('descStrategy').value === 'region') {
                ctx.strokeStyle = '#2196f3';
                ctx.lineWidth = 3;
                ctx.setLineDash([10, 5]);
                ctx.strokeRect((dXS/100)*canvas.width, (dYS/100)*canvas.height, ((dXE-dXS)/100)*canvas.width, ((dYE-dYS)/100)*canvas.height);
                ctx.setLineDash([]);
            }

            canvas.classList.add('visible');
        }

        function switchProfile(name) {
            currentProfile = name;
            document.querySelectorAll('.profile-tab').forEach(t => t.classList.toggle('active', t.textContent === name));
            loadProfile();
        }

        function loadProfile() {
            const p = profiles[currentProfile];
            document.getElementById('blacklistKeywords').value = p.blacklistKeywords;
            document.getElementById('titleStrategy').value = p.titleStrategy;
            document.getElementById('titleYStart').value = p.titleYStart;
            document.getElementById('titleYEnd').value = p.titleYEnd;
            document.getElementById('titleXStart').value = p.titleXStart;
            document.getElementById('titleXEnd').value = p.titleXEnd;
            document.getElementById('descStrategy').value = p.descStrategy;
            document.getElementById('descYStart').value = p.descYStart;
            document.getElementById('descYEnd').value = p.descYEnd;
            document.getElementById('descXStart').value = p.descXStart;
            document.getElementById('descXEnd').value = p.descXEnd;
            document.getElementById('imageYStart').value = p.imageYStart;
            document.getElementById('imageYEnd').value = p.imageYEnd || 100;
            document.getElementById('imageXStart').value = p.imageXStart;
            document.getElementById('imageXEnd').value = p.imageXEnd;
            document.getElementById('minTitleLength').value = p.minTitleLength;
            toggleTitle();
            toggleDesc();
            if(img.src) updateOverlay();
        }

        function saveProfile() {
            profiles[currentProfile] = {
                blacklistKeywords: document.getElementById('blacklistKeywords').value,
                titleStrategy: document.getElementById('titleStrategy').value,
                titleYStart: parseInt(document.getElementById('titleYStart').value),
                titleYEnd: parseInt(document.getElementById('titleYEnd').value),
                titleXStart: parseInt(document.getElementById('titleXStart').value),
                titleXEnd: parseInt(document.getElementById('titleXEnd').value),
                descStrategy: document.getElementById('descStrategy').value,
                descYStart: parseInt(document.getElementById('descYStart').value),
                descYEnd: parseInt(document.getElementById('descYEnd').value),
                descXStart: parseInt(document.getElementById('descXStart').value),
                descXEnd: parseInt(document.getElementById('descXEnd').value),
                imageYStart: parseInt(document.getElementById('imageYStart').value),
                imageYEnd: parseInt(document.getElementById('imageYEnd').value),
                imageXStart: parseInt(document.getElementById('imageXStart').value),
                imageXEnd: parseInt(document.getElementById('imageXEnd').value),
                minTitleLength: parseInt(document.getElementById('minTitleLength').value)
            };
            alert('Saved!');
        }

        function toggleTitle() {
            document.getElementById('titleRegion').style.display = document.getElementById('titleStrategy').value === 'region' ? 'block' : 'none';
            if(img.src) updateOverlay();
        }

        function toggleDesc() {
            document.getElementById('descRegion').style.display = document.getElementById('descStrategy').value === 'region' ? 'block' : 'none';
            if(img.src) updateOverlay();
        }

        function cropRegion(yS, yE, xS, xE) {
            const c = document.createElement('canvas');
            c.width = img.naturalWidth;
            c.height = img.naturalHeight;
            c.getContext('2d').drawImage(img, 0, 0);
            const y1 = Math.floor((yS/100)*c.height);
            const y2 = Math.floor((yE/100)*c.height);
            const x1 = Math.floor((xS/100)*c.width);
            const x2 = Math.floor((xE/100)*c.width);
            const rc = document.createElement('canvas');
            rc.width = x2-x1;
            rc.height = y2-y1;
            rc.getContext('2d').drawImage(c, x1, y1, rc.width, rc.height, 0, 0, rc.width, rc.height);
            return rc;
        }

        function previewTitle() {
            if(!img.src || document.getElementById('titleStrategy').value !== 'region') return;
            const c = cropRegion(
                parseInt(document.getElementById('titleYStart').value),
                parseInt(document.getElementById('titleYEnd').value),
                parseInt(document.getElementById('titleXStart').value),
                parseInt(document.getElementById('titleXEnd').value)
            );
            document.getElementById('previewImg').src = c.toDataURL();
            document.getElementById('modal').style.display = 'flex';
        }

        function previewDesc() {
            if(!img.src || document.getElementById('descStrategy').value !== 'region') return;
            const c = cropRegion(
                parseInt(document.getElementById('descYStart').value),
                parseInt(document.getElementById('descYEnd').value),
                parseInt(document.getElementById('descXStart').value),
                parseInt(document.getElementById('descXEnd').value)
            );
            document.getElementById('previewImg').src = c.toDataURL();
            document.getElementById('modal').style.display = 'flex';
        }

        function previewImage() {
            if(!img.src) return;
            const c = document.createElement('canvas');
            c.width = img.naturalWidth;
            c.height = img.naturalHeight;
            c.getContext('2d').drawImage(img, 0, 0);
            const yS = Math.floor((parseInt(document.getElementById('imageYStart').value)/100)*c.height);
            const yE = Math.floor((parseInt(document.getElementById('imageYEnd').value)/100)*c.height);
            const x1 = Math.floor((parseInt(document.getElementById('imageXStart').value)/100)*c.width);
            const x2 = Math.floor((parseInt(document.getElementById('imageXEnd').value)/100)*c.width);
            const rc = document.createElement('canvas');
            rc.width = x2-x1;
            rc.height = yE-yS;
            rc.getContext('2d').drawImage(c, x1, yS, rc.width, rc.height, 0, 0, rc.width, rc.height);
            document.getElementById('previewImg').src = rc.toDataURL();
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        async function extract() {
            document.getElementById('extractBtn').disabled = true;
            const c = document.createElement('canvas');
            c.width = img.naturalWidth;
            c.height = img.naturalHeight;
            c.getContext('2d').drawImage(img, 0, 0);

            let title = 'Not found';
            if(document.getElementById('titleStrategy').value === 'region') {
                const tc = cropRegion(
                    parseInt(document.getElementById('titleYStart').value),
                    parseInt(document.getElementById('titleYEnd').value),
                    parseInt(document.getElementById('titleXStart').value),
                    parseInt(document.getElementById('titleXEnd').value)
                );
                const tr = await Tesseract.recognize(tc, 'eng');
                title = extractTitleText(tr.data.text);
            } else {
                const r = await Tesseract.recognize(c, 'eng');
                title = extractTitleText(r.data.text);
            }

            const fullR = await Tesseract.recognize(c, 'eng');
            const price = extractPrice(fullR.data.text);

            let desc = 'Not found';
            if(document.getElementById('descStrategy').value === 'region') {
                const dc = cropRegion(
                    parseInt(document.getElementById('descYStart').value),
                    parseInt(document.getElementById('descYEnd').value),
                    parseInt(document.getElementById('descXStart').value),
                    parseInt(document.getElementById('descXEnd').value)
                );
                const dr = await Tesseract.recognize(dc, 'eng');
                desc = extractDescText(dr.data.text, title, price);
            }

            const pc = cropRegion(
                parseInt(document.getElementById('imageYStart').value),
                parseInt(document.getElementById('imageYEnd').value),
                parseInt(document.getElementById('imageXStart').value),
                parseInt(document.getElementById('imageXEnd').value)
            );

            document.getElementById('results').innerHTML = `
                <div class="result-item"><strong>Title:</strong> ${title}</div>
                <div class="result-item"><strong>Price:</strong> ${price}</div>
                <div class="result-item"><strong>Description:</strong> ${desc}</div>
                <div class="result-item"><strong>Photo:</strong><br><img class="image-preview" src="${pc.toDataURL()}"></div>
            `;
            document.getElementById('extractBtn').disabled = false;
        }

        function extractTitleText(txt) {
            const lines = txt.split('\n').map(l=>l.trim()).filter(l=>l);
            const bl = document.getElementById('blacklistKeywords').value.split(',').map(k=>k.trim().toLowerCase());
            const minLen = parseInt(document.getElementById('minTitleLength').value) || 5;
            for(let line of lines) {
                if(bl.some(k=>line.toLowerCase().includes(k))) continue;
                // Don't skip lines with $ anymore - titles often have prices in them
                const clean = line.replace(/[^a-zA-Z0-9\s\-$.,&()']/g,'').trim();
                if(clean.length >= minLen && clean.split(/\s+/).length > 1) return clean;
            }
            return 'Not found';
        }

        function extractPrice(txt) {
            const m = txt.match(/\$\s*(\d+(?:,\d{3})*(?:\.\d{2})?)/g);
            return m ? m[0] : 'Not found';
        }

        function extractDescText(txt, title, price) {
            let lines = txt.split('\n').map(l=>l.trim()).filter(l=>l && l!==title);
            // Don't filter out lines with price - descriptions often mention price
            const bl = document.getElementById('blacklistKeywords').value.split(',').map(k=>k.trim().toLowerCase());
            const dl = lines.filter(l => {
                if(bl.some(k=>l.toLowerCase().includes(k))) return false;
                const sc = (l.match(/[^a-zA-Z0-9\s\-$.,&()'!?]/g)||[]).length/l.length;
                if(sc>0.2 || l.length<10) return false;
                const lc = (l.match(/[a-zA-Z]/g)||[]).length;
                return lc >= l.length*0.4;
            });
            return dl.slice(0,15).join(' ').substring(0,1000).trim() || 'Not found';
        }

        function exportProfiles() {
            document.getElementById('exportCode').textContent = `const EXTRACTION_PROFILES = ${JSON.stringify(profiles, null, 2)};`;
            document.getElementById('exportCode').style.display = 'block';
        }

        loadProfile();
    </script>
</body>
</html>